{% extends 'base.html' %}
{% load markup %}

{% block title %}Item: {{object.title}}{% endblock %}

{% block primarynavtabs %}
{% endblock %}

{% block primarynavtabsright %}
{% endblock %}


{% block content %}
<ul class="breadcrumb">
  <li><a href="/"><span class="glyphicon glyphicon-home"></span></a></li>
  <li><a href="{{object.milestone.project.get_absolute_url }}">{{object.milestone.project.name}}</a></li>
  <li><a href="{{object.milestone.get_absolute_url }}">{{object.milestone.name}}</a></li>
</ul>
<h1>#{{object.iid}} {% if object.is_bug %}BUG:{% endif %} {{object.title}}</h1>

<ul class="nav nav-pills">
	<li><a href="http://pmt.ccnmtl.columbia.edu/item/{{object.iid}}/">Return to the old PMT</a></li>
</ul>

<div class="modal fade" id="add-hours" tabindex="-1" role="dialog" aria-labelledby="add-tracker-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="add-tracker-label">Log Time</h4>
      </div>
      <div class="modal-body">
				<form id="add-tracker-form" action="/api/1.0/tracker/add/" method="post" role="form">
					<input type="hidden" name="pid" value="{{object.pid}}" id="tracker-pid-input" />

					<div class="row">
						<div class="col-sm-3">
							<input type="text" name="time" placeholder="time"
										 id="tracker-time-input"
										 class="form-control" />
						</div>
					</div>
				</form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="add-tracker-button">Add</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


{% if object.resolvable %}
<form action="resolve/" method="post" role="form">
<div class="modal fade" id="resolve" tabindex="-1" role="dialog" aria-labelledby="resolve-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="resolve-label">Resolve Item</h4>
      </div>
      <div class="modal-body">
				<div class="form-group">
					<label for="resolve-status">Resolve Status</label>
					<select class="form-control" id="resolve-status" name="r_status">
						<option value="FIXED">FIXED</option>
						<option value="INVALID">INVALID</option>
						<option value="WORKSFORME">WORKSFORME</option>
						<option value="WONTFIX">WONTFIX</option>
						<option value="DUPLICATE">DUPLICATE</option>
						<option value="NEEDINFO">NEEDINFO</option>
					</select>
				</div>

				<div class="form-group">
					<textarea name="comment" class="form-control" rows="5"></textarea>
				</div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <input type="submit" class="btn btn-primary" value="Resolve" />
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
</form>
{% endif %}

{% if object.inprogressable %}
<form action="inprogress/" method="post" role="form">
<div class="modal fade" id="mark-in-progress" tabindex="-1" role="dialog" aria-labelledby="inprogress-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="inprogress-label">Mark as In Progress</h4>
      </div>
      <div class="modal-body">
				<div class="form-group">
					<textarea name="comment" class="form-control" rows="5"></textarea>
				</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <input type="submit" class="btn btn-primary" value="Mark as In Progress" />
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
</form>
{% endif %}

{% if object.verifiable %}
<form action="verify/" method="post" role="form">
<div class="modal fade" id="verify" tabindex="-1" role="dialog" aria-labelledby="verify-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="verify-label">Verify</h4>
      </div>
      <div class="modal-body">
				<div class="form-group">
					<textarea name="comment" class="form-control" rows="5"></textarea>
				</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <input type="submit" class="btn btn-primary" value="Verify" />
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
</form>
{% endif %}

{% if object.reopenable %}
<form action="reopen/" method="post" role="form">
<div class="modal fade" id="reopen" tabindex="-1" role="dialog" aria-labelledby="reopen-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="reopen-label">Reopen</h4>
      </div>
      <div class="modal-body">
				<div class="form-group">
					<textarea name="comment" class="form-control" rows="5"></textarea>
				</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <input type="submit" class="btn btn-primary" value="Reopen" />
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
</form>
{% endif %}

<form action="comment/" method="post" role="form">
<div class="modal fade" id="add-comment" tabindex="-1" role="dialog" aria-labelledby="add-comment-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="add-comment-label">Add Comment</h4>
      </div>
      <div class="modal-body">
					<div class="form-group">
						<textarea name="comment" class="form-control" rows="5"></textarea>
					</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <input type="submit" class="btn btn-primary" value="Add Comment" />
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
</form>


<dl class="dl-horizontal">
<dt>STATUS<dt><dd><span class="{{object.status_class}}">{{ object.status }} {{object.r_status}}</span></dd>
<dt>OWNER<dt><dd><a href="{{object.owner.get_absolute_url}}">{{object.owner}}</a></dd>
<dt>ASSIGNED<dt><dd><a href="{{object.assigned_to.get_absolute_url}}">{{object.assigned_to}}</a></dd>
<dt>PRIORITY<dt><dd><span class="pr{{object.priority}}">{{object.priority_label}}</span></dd>
<dt>TARGET DATE<dt><dd>{{object.target_date}}</dd>
{% if object.estimated_time %}
<dt>ESTIMATED TIME<dt><dd>{{object.estimated_time}}</dd>
{% endif %}
{% if object.actualtime_set.count %}
<dt>TIME LOGGED</dt>
<dd>
{% for at in object.actualtime_set.all %}
<ul>
	<li>{{at.actual_time}} <a href="{{at.resolver.get_absolute_url}}">{{at.resolver.fullname}}</a>
	{{at.completed}}</li>
</ul>
{% endfor %}
</dd>
{% endif %}
{% if object.url %}
<dt>URL<dt><dd>{{object.url}}</dd>
{% endif %}
<dt>LAST MOD<dt><dd>{{object.last_mod}}</dd>
</dl>
<hr />
{{object.description|markdown}}
<hr />

<div class="btn-toolbar">
<div class="btn-group">
{% if object.resolvable %}
	<a class="btn btn-success" href="#" data-toggle="modal"
		 data-target="#resolve"><span class="glyphicon
		 glyphicon-ok"></span> Resolve</a>
{% endif %}

{% if object.inprogressable %}
	<a class="btn btn-default" href="#" data-toggle="modal"
		 data-target="#mark-in-progress">Mark as In-Progress</a>
{% endif %}

{% if object.verifiable %}
	<a class="btn btn-success" href="#" data-toggle="modal"
		 data-target="#verify"><span class="glyphicon
		 glyphicon-ok"></span> Verify</a>
{% endif %}

{% if object.reopenable %}
	<a class="btn btn-danger" href="#" data-toggle="modal"
		 data-target="#reopen"><span class="glyphicon
		 glyphicon-repeat"></span> Reopen</a>
{% endif %}
</div>
<div class="btn-group pull-right">
	<a class="btn btn-primary" href="#" data-toggle="modal"
	data-target="#add-comment"><span class="glyphicon
		 glyphicon-comment"> Add Comment</a>
	<a class="btn btn-primary" href="#" data-toggle="modal"
	data-target="#add-hours"><span class="glyphicon
		 glyphicon-time"> Log Time</a>
	<a class="btn btn-primary" href="#" data-toggle="modal"
		 data-target="#split">Split Item</a>
</div>
</div>


{% if item.attachment_set.all.count %}
<h2>Attachments</h2>

<table class="table table-condensed">
	{% for attachment in item.attachment_set.all %}
	<tr>
		<td>
			<a href="{{attachment.get_absolute_url}}">{{attachment.title|default:attachment.filename}}</a>
		</td>
		<td><i>[{{attachment.last_mod}}]</i></td>
		<td>{{attachment.author.fullname}}</td>
	</tr>
	{% if attachment.image %}
	<tr><td colspan="3"><img src="{{attachment.src}}" /></td></tr>
	{% else %}
	<tr><td colspan="3">{{attachment.description|markdown}}</td></tr>
	{% endif %}
{% endfor %}
</table>
{% endif %}


<h2>HISTORY</h2>

<table class="table">
{% for history_item in object.history %}
<tr>
<td class="{{history_item.status_class}}">{{history_item.status}}</td>
<td>
<a href="{{history_item.user.get_absolute_url}}">{{history_item.user.fullname}}</a>
</td>
<td>
<nobr>{{history_item.timestamp}}</nobr>
</td>
<td>
{{history_item.comment|safe}}
</td>
</tr>
{% endfor %}
</table>

{% endblock %}


{% block js %}
<script>
$(document).ready(function() 
    { 
        $("#add-tracker-button").click(function(event) {
           var time = $("#tracker-time-input").val();

           $.ajax({
             type: "POST",
             url: "/api/1.0/items/{{object.iid}}/hours/",
             data: {time: time}
           }).done(function (msg) {
              window.location.reload();
           });
           event.preventDefault();
        });
    } 
);
</script>
{% endblock %}
