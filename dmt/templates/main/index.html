{% extends 'base.html' %}
{% load claimtags %}
{% block extraclass %} class="dashboard"{% endblock %}
{% block title %}My Dashboard{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{STATIC_URL}}css/typeahead.js-bootstrap.css">
{% endblock %}


{% block primarynavtabs %}
{% endblock %}

{% block primarynavtabsright %}
{% endblock %}


{% block content %}

<h1>My Dashboard</h1>

{% if request.user.is_anonymous %}
  <p>Please Login</p>
{% else %}
  {% pmtuser as pmt_user %}

<p>
    <ul class="nav nav-pills">
        <li><a href="http://pmt.ccnmtl.columbia.edu/home.pl">Return to the old PMT</a></li>
        <li><a href="#" data-toggle="modal"
               data-target="#add-tracker">
                <span class="glyphicon glyphicon-time"></span>
                Add Tracker
        </a></li>
        <li>
            <a href="{% url 'add_trackers' %}">
                <span class="glyphicon glyphicon-time"></span>
                Add Trackers
            </a>
        </li>
				<li>
					  <a href="/report/user/{{pmt_user.username}}/weekly/">
						    <span class="glyphicon glyphicon-stats"></span>
						    Weekly Report
					  </a>
				</li>
    </ul>
</p>

<div class="modal fade" id="add-tracker" tabindex="-1" role="dialog" aria-labelledby="add-tracker-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="add-tracker-label">Add Tracker</h4>
            </div>
            <div class="modal-body">
                <form id="add-tracker-form" action="/api/1.0/tracker/add/" method="post" role="form">
                    <input type="hidden" name="pid" value="0" id="tracker-pid-input" />

                    <div class="row">
                        <div class="col-sm-12">
                            <input type="text" name="project" placeholder="project"
                                   class="form-control" id="project-input" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-7">
                            <input type="text" name="title" placeholder="task"
                                   id="tracker-task-input"
                                   class="form-control"/>
                        </div>

                        <div class="col-sm-3">
                            <input type="text" name="time" placeholder="time"
                                   id="tracker-time-input"
                                   class="form-control" />
                        </div>

                        <div class="col-sm-2">
                            <input type="text" name="client" placeholder="client"
                                   id="tracker-client-input"
                                   class="form-control" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="submit" form="add-tracker-form"
                        class="btn btn-primary" id="add-tracker-button">Add</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

{% with pmt_user.progress_report as progress %}
<div class="progress">
    <div class="progress-bar {% if progress.behind %}progress-bar-warning{% else %}progress-bar-success{% endif %}"
         role="progressbar"
         aria-valuenow="{{progress.week_percentage}}" aria-valuemin="0"
         aria-valuemax="100" style="width: {{progress.week_percentage}}%;">
        {{progress.hours_logged|floatformat}} hours
    </div>
</div>
{% endwith %}

{% if pmt_user.username %}
{% if pmt_user.items %}
<table class="table table-striped table-condensed table-responsive"
       id="user-items"
       data-show-columns="true"
       data-sort-name="priority"
       data-sort-order="desc">
    <thead>
        <tr>
            <th data-field="item"
                data-sortable="true">Item</th>
            <th data-field="priority"
                data-sortable="true" class="hidden-xs">Priority</th>
            <th data-field="project"
                data-sortable="true" class="hidden-xs">Project</th>
            <th data-field="target-date"
                data-sortable="true" class="hidden-xs">Target Date</th>
            <th data-field="milestone"
                data-visible="false"
                data-sortable="true" class="hidden-xs">Milestone</th>
            <th data-field="owner"
                data-visible="false"
                data-sortable="true" class="hidden-xs">Owner</th>
            <th data-field="modified"
                data-sortable="true" class="hidden-xs">Modified</th>
        </tr>
    </thead>
    <tbody>
        {% for item in pmt_user.items %}
        <tr>
            <td data-field="item">
                <div class="status-indicator {{item.target_date_status}} {{item.status_class}}"
                data-toggle="tooltip"
                data-placement="bottom"
                title="{% ifequal item.status 'INPROGRESS' %}{{item.status_class}}{% else %}{{item.target_date_status}}{% endifequal %}"></div>
                
                {% if item.is_bug %}
                <img src="{{STATIC_URL}}img/tinybug.gif"
                     width="14" height="14"/>
                {% endif %}
                <a href="{{item.get_absolute_url}}">
                    {{item.title|truncatechars:70}}
                </a>
                {% ifequal item.status "OPEN" %}
                {% else %}
                <span class="{{item.status_class}} badge pull-right">
                    {{item.status_display}}
                </span>
                {% endifequal %}
            </td>
            <td data-field="priority" class="pr{{item.priority}} hidden-xs">
                <span class="invisible">{{item.priority}}</span>
                {{item.priority_label}}
            </td>
            <td data-field="project" class="hidden-xs">
                <a href="{{item.milestone.project.get_absolute_url}}">
                    {{item.milestone.project.name|truncatechars:40}}
                </a>
            </td>
            <td data-field="target-date" class="{{item.target_date_status}} hidden-xs">
                {{item.target_date|date:"Y-m-d"}}
            </td>
            <td data-field="milestone" class="hidden-xs">
                <a href="{% url 'milestone_detail' item.milestone.mid %}">
                    {{item.milestone|truncatechars:40}}
                </a>
            </td>
            <td data-field="owner" class="hidden-xs">
                <a href="{% url 'user_detail' item.owner.username %}">
                    {{item.owner|truncatechars:40}}
                </a>
            </td>
            <td data-field="modified" class="hidden-xs">
                {{item.last_mod|date:"Y-m-d"}}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>You have no active items right now.</p>
{% endif %}

{% else %}
<div class="alert alert-error">
    You need to <a href="/claim/">claim your account</a> first.
</div>
{% endif %}
{% endif %}

{% endblock %}

{% block js %}
<script src="{{STATIC_URL}}js/libs/typeahead/bloodhound.min.js"></script>
<script src="{{STATIC_URL}}js/libs/typeahead/typeahead.jquery.min.js"></script>

<script>
$(document).ready(function() {
    {% pmtuser as pmt_user %}
    {% if pmt_user.items %}
        var table = $('table#user-items').DataTable({
            aoColumnDefs: [
                { bVisible: false, aTargets: [4, 5] }
            ],
            dom: 'C<"clear">lfrtip',
            colVis: {
                iOverlayFade: 0,
            }
        });
        table
            .order([1, 'desc'], [3, 'asc'])
            .draw();
    {% endif %}

    var projects = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        prefetch: {
            url: '/drf/projects/',
            filter: function (projects) {
                return $.map(projects.results, function (data) {
                    return {
                        name: data.name,
                        pid: data.pid
                    };
                });
            }
        },
        remote: {
        url: '/drf/projects/?search=%QUERY',
            filter: function (projects) {
                return $.map(projects.results, function (data) {
                    return {
                        name: data.name,
                        pid: data.pid
                    };
                });
            }
        }
    });
    projects.initialize();
    $("#project-input").typeahead(null, {
        name: 'results',
        displayKey: 'name',
        source: projects.ttAdapter()
    });
    $("#project-input").on("typeahead:selected", function (object, datum) {
        $("#tracker-pid-input").val(datum.pid);
    });
    $('.status-indicator').tooltip()
});
</script>
{% endblock %}
